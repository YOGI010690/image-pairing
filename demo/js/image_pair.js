H5P.ImagePair=(function(EventDispatcher,$,UI){function ImagePair(parameters,id){var self=this;EventDispatcher.call(self);var cards=[],mates=[];var clicked;var addCard=function(card,mate){card.on('selected',function(){self.triggerXAPI('interacted');if(clicked===undefined){card.setSelected();self.prepareMateContainer();clicked=card;}else if(clicked===card){card.$card.toggleClass('h5p-image-pair-item-selected');self.reverseMateContainer();clicked=undefined;}else{clicked.removeSelected();card.setSelected();self.prepareMateContainer();clicked=card;}});card.on('shiftContainer',function(){if(card.isSelected){for(var i=0;i<mates.length;i++){if(mates[i].isPaired===false){mates[i].setFocus();return;}}}else{for(var i=0;i<mates.length;i++){if(mates[i].isPaired===true){mates[i].setFocus();return;}}}});mate.on('shiftContainer',function(){if(clicked){clicked.setFocus();return;}else{for(var i=0;i<cards.length;i++){if(cards[i].isPaired===false){cards[i].setFocus();return;}}}});card.on('makeSelection',function(){card.trigger('selected');});mate.on('makeSelection',function(){if(!mate.isPaired){mate.currentPair=clicked;if(clicked){clicked.makeUntabbable();}
mate.trigger('selected');}else{mate.currentPair.$card.removeClass('h5p-image-pair-item-disabled');mate.detach();mate.currentPair.isPaired=false;mate.currentPair.makeTabbable();mate.currentPair=undefined;}});var createPairChangeFocusHandler=function(direction){return function(){for(var i=0;i<mates.length;i++){if(mates[i]===mate){var nextPair,fails=0;do{fails++;nextPair=mates[i+(direction*fails)];if(!nextPair){return;}}while(!nextPair.isPaired);mate.makeUntabbable();nextPair.setFocus();}}}}
var createCardChangeFocusHandler=function(cardtype,direction){return function(){var list=(cardtype===1)?cards:mates;var currentItem=(cardtype===1)?card:mate;for(var i=0;i<list.length;i++){if(list[i]===currentItem){var nextItem,fails=0;do{fails++;nextItem=list[i+(direction*fails)];if(!nextItem){return;}}while(nextItem.isPaired);currentItem.makeUntabbable();nextItem.setFocus();}}}};var createEndCardFocusHandler=function(cardtype,direction){return function(){var list=(cardtype===1)?cards:mates;var currentItem=(cardtype===1)?card:mate;var focusSet=false;for(var i=0;i<list.length;i++){var j=(direction===-1?list.length-(i+1):i);if(!focusSet&&!list[j].isPaired){list[j].setFocus();focusSet=true;}else if(list[j]===currentItem){currentItem.makeUntabbable();}}};};var createEndPairFocusHandler=function(direction){return function(){var focusSet=false;for(var i=0;i<mates.length;i++){var j=(direction===-1?mates.length-(i+1):i);if(!focusSet&&mates[j].isPaired){mates[j].setFocus();focusSet=true;}else if(mates[j]===mate){mate.makeUntabbable();}}};};card.on('next',createCardChangeFocusHandler(1,1));card.on('prev',createCardChangeFocusHandler(1,-1));mate.on('next',createCardChangeFocusHandler(-1,1));mate.on('prev',createCardChangeFocusHandler(-1,-1));mate.on('nextPair',createPairChangeFocusHandler(1));mate.on('prevPair',createPairChangeFocusHandler(-1));card.on('first',createEndCardFocusHandler(1,1));card.on('last',createEndCardFocusHandler(1,-1));mate.on('first',createEndCardFocusHandler(-1,1));mate.on('last',createEndCardFocusHandler(-1,-1));mate.on('firstPair',createEndPairFocusHandler(1));mate.on('lastPair',createEndPairFocusHandler(-1));mate.on('selected',function(){if(clicked!==undefined){mate.trigger('checkPair',clicked);mate.pair(clicked);mate.transform();clicked.disable();clicked=undefined;self.reverseMateContainer();}});mate.on('unpair',function(){mate.pairingStatus=undefined;});mate.on('checkPair',function(pair){if(pair.data===card){mate.pairingStatus=true;}else{mate.pairingStatus=false;}});mate.on('attachPair',function(){if(mate.$top!==undefined){mate.$top.empty();}
mate.pair(card);mate.setSolved();});cards.push(card);mates.push(mate);};var prepareResult=function(){var score=0;for(var i=0;i<mates.length;i++){if(mates[i].pairingStatus===true){mates[i].setCorrect();score++;}else if(mates[i].pairingStatus===false){mates[i].setIncorrect();}}
return score;};var createButton=function(callback,icon,name){return UI.createButton({title:'Submit',click:function(event){callback();},keypress:function(event){if(event.which===13||event.which===32){event.preventDefault();callback();}},html:'<span><i class="fa '+icon+
'" aria-hidden="true"></i></span>&nbsp;'+name});};self.prepareMateContainer=function(){for(var i=0;i<mates.length;i++){if(mates[i].isPaired===true){mates[i].$front.removeClass('event-enabled').addClass('visual-disable');mates[i].$rear.removeClass('event-enabled').addClass('visual-disable');mates[i].$top.removeClass('event-enabled').addClass('event-disabled');}else{mates[i].$card.removeClass('event-disabled').addClass('event-enabled').addClass('grey-dash');}}};self.reverseMateContainer=function(){for(var i=0;i<mates.length;i++){if(mates[i].isPaired===true){mates[i].$front.removeClass('visual-disable').addClass('event-enabled');mates[i].$rear.removeClass('visual-disable').addClass('event-enabled');mates[i].$top.removeClass('grey-dash').removeClass('event-enabled');}else{mates[i].$card.removeClass('event-enabled').addClass('event-disabled').removeClass('grey-dash');}}};self.showCheckButton=function(){self.$checkButton=createButton(self.displayResult,'fa-check',parameters.l10n.checkAnswer);self.$checkButton.appendTo(self.$footer);};self.showSolution=function(){self.$showSolutionButton.remove();for(var i=0;i<mates.length;i++){if(mates[i].pairingStatus!==true){mates[i].trigger('attachPair');mates[i].pairingStatus=true;}}};self.retry=function(){self.$footer.empty();self.showCheckButton();for(var i=0;i<mates.length;i++){if(mates[i].isPaired===true){mates[i].detach();if(mates[i].currentPair){mates[i].currentPair.isPaired=false;}}
cards[i].makeUntabbable();mates[i].makeUntabbable();}
cards[0].setFocus();mates[0].makeTabbable();self.$footer.appendTo(self.$wrapper);self.$gameContainer.removeClass('event-disabled').addClass('event-enabled');self.$wrapper.find('.h5p-image-pair-item-disabled').removeClass('h5p-image-pair-item-disabled');};self.displayResult=function(){var result=prepareResult();self.$wrapper.find('.event-enabled').removeClass('event-enabled').addClass('event-disabled');self.$checkButton.remove();self.$feedbacks=$('<div class="feedback-container" />');var scoreText=parameters.l10n.score;scoreText=scoreText.replace('@score',result).replace('@total',cards.length);self.$feedbacks.html('<div class="feedback-text">'+scoreText+
'</div>');self.$progressBar=UI.createScoreBar(cards.length,'scoreBarLabel');self.$progressBar.setScore(result);self.$progressBar.appendTo(self.$feedbacks);self.$feedbacks.appendTo(self.$footer);if(parameters.behaviour){self.$retryButton=createButton(self.retry,'fa-repeat',parameters.l10n.tryAgain);self.$retryButton.appendTo(self.$footer);}
if(result!=cards.length){self.$showSolutionButton=createButton(self.showSolution,'fa-eye',parameters.l10n.showSolution);self.$showSolutionButton.appendTo(self.$footer);}
var completedEvent=self.createXAPIEventTemplate('completed');completedEvent.setScoredResult(result,cards.length,self,true,result===cards.length);self.trigger(completedEvent);self.$footer.children('button').first().focus();self.trigger('resize');};var cardsToUse=parameters.cards;for(var i=0;i<cardsToUse.length;i++){var cardParams=cardsToUse[i];if(ImagePair.Card.isValid(cardParams)){var cardTwo,cardOne=new ImagePair.Card(cardParams.image,id,cardParams.imageAlt);if(ImagePair.Card.hasTwoImages(cardParams)){cardTwo=new ImagePair.Card(cardParams.match,id,cardParams.matchAlt);cardOne.hasTwoImages=cardTwo.hasTwoImages=true;}else{cardTwo=new ImagePair.Card(cardParams.image,id,cardParams.imageAlt);}
addCard(cardOne,cardTwo);}}
H5P.shuffleArray(cards);H5P.shuffleArray(mates);self.attach=function($container){self.triggerXAPI('attempted');self.$wrapper=$container.addClass('h5p-image-pair').html('');$('<div class="h5p-image-pair-desc">'+parameters.taskDescription+
'</div>').appendTo($container).focus();self.$gameContainer=$('<div class="game-container event-enabled"/>');var $cardList=$('<ul class="card-container" />');var $mateList=$('<ul class="mate-container"/>');self.$footer=$('<div class="footer-container"/>');self.$checkButton=createButton(self.displayResult,'fa-check',parameters.l10n.checkAnswer);self.$checkButton.appendTo(self.$footer);for(var i=0;i<cards.length;i++){cards[i].appendTo($cardList);mates[i].appendTo($mateList);cards[i].$card.attr("data-card",i);cards[i].$card.addClass("draggable");mates[i].$card.addClass('droppable');mates[i].$card.attr("data-mate",i);}
$cardList.find('.draggable').draggable({opacity:0.7,helper:"clone",handle:"div",revert:'invalid',start:function(event,ui){self.triggerXAPI('interacted');var cardId=$(this).data('card');cards[cardId].$card.removeClass('h5p-image-pair-item-hover').removeClass('h5p-image-pair-item-selected').addClass('h5p-image-pair-item-disabled');$cardList.find('.ui-draggable-dragging').removeClass('h5p-image-pair-item-hover');self.prepareMateContainer();},stop:function(){var cardId=$(this).data('card');cards[cardId].$card.removeClass('h5p-image-pair-item-disabled');self.reverseMateContainer();}});$mateList.find('.droppable').droppable({tolerance:'intersect',over:function(event,ui){var mateId=$(this).data('mate');mates[mateId].$card.addClass('h5p-image-pair-item-hover').removeClass('grey-dash').addClass('blue-dash');},out:function(event,ui){var mateId=$(this).data('mate');mates[mateId].$card.removeClass('h5p-image-pair-item-hover').removeClass('blue-dash').addClass('grey-dash');},drop:function(event,ui){var cardId=$(ui.draggable).data('card');var mateId=$(this).data('mate');setTimeout(function(){cards[cardId].$card.addClass('h5p-image-pair-item-disabled');},0.01);mates[mateId].pair(cards[cardId]);mates[mateId].trigger('checkPair',cards[cardId]);mates[mateId].$card.removeClass('h5p-image-pair-item-hover').removeClass('droppable').removeClass('blue-dash').droppable("option","disabled",true);}});if($cardList.children().length>=0){$cardList.appendTo(self.$gameContainer);$mateList.appendTo(self.$gameContainer);mates[0].makeTabbable();cards[0].setFocus();self.$gameContainer.appendTo($container);self.$footer.appendTo($container);}};}
ImagePair.prototype=Object.create(EventDispatcher.prototype);ImagePair.prototype.constructor=ImagePair;return ImagePair;})(H5P.EventDispatcher,H5P.jQuery,H5P.JoubelUI);